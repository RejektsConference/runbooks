name: Merge Markdown Files for Roles into README

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  merge-md:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run merge script
        run: |
          cd roles
          rm -f README.md
          echo "> This file is automatically generated from the individual role documents. Do not edit manually\n\n" >> README.md
          for file in *.md; do
            if [[ "$file" != "README.md" ]] && [[ "$file" != "_template.md" ]] ; then
              cat "$file" >> README.md
              echo -e "\n\n---\n" >> README.md
            fi
          done

      - name: Commit and push changes
        run: |
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Auto: Merge role .md files into README.md [skip ci]"
          git push
