name: Merge Markdown Files for Roles into README

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  merge-md:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: Run merge script
        run: |
          cd roles
          rm -f README.md
          echo "> This file is automatically generated from the individual role documents. Do not edit manually\n\n" >> README.md
          for file in *.md; do
            if [[ "$file" != "README.md" ]] && [[ "$file" != "_template.md" ]] ; then
              cat "$file" >> README.md
              echo -e "\n\n---\n" >> README.md
            fi
          done

      - name: Commit and push changes
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy-key
          chmod 600 ~/.ssh/deploy-key
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add ~/.ssh/deploy-key

          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Auto: Merge role .md files into README.md [skip ci]"
          git push

          ssh-add -D
          rm -rf ~/.ssh/deploy-key
          rm -rf ~/.ssh/known_hosts
